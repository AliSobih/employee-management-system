<p-dialog 
  [(visible)]="visible" 
  [modal]="true" 
  [style]="{ width: '700px', maxHeight: '90vh' }" 
  [header]="formTitle"
  [draggable]="false" 
  [resizable]="false" 
  [closeOnEscape]="true"
  (onHide)="onClose()"
  class="employee-form-dialog"
>
  <form [formGroup]="employeeForm" (ngSubmit)="onSubmit()" class="p-fluid">
    <div class="form-container">
      <!-- Left Column - Basic Info -->
      <div class="form-column">
        <!-- Code Field -->
        <div class="field mb-3">
          <label for="code" class="form-label">
            <i class="pi pi-hashtag mr-2"></i>
            Employee Code *
          </label>
          <div class="p-inputgroup">
            <span class="p-inputgroup-addon">
              <i class="pi pi-id-card"></i>
            </span>
            <input 
              type="text" 
              id="code" 
              pInputText 
              formControlName="code" 
              placeholder="Enter employee code"
              [ngClass]="{ 'ng-invalid ng-dirty': employeeForm.get('code')?.invalid && employeeForm.get('code')?.touched }"
              autocomplete="off"
            />
            <span class="p-inputgroup-addon" *ngIf="checkingCode">
              <i class="pi pi-spinner pi-spin"></i>
            </span>
          </div>
          
          <div class="validation-messages mt-1">
            <small *ngIf="employeeForm.get('code')?.hasError('required') && employeeForm.get('code')?.touched" 
                   class="p-error">
              <i class="pi pi-exclamation-circle mr-1"></i>
              {{ getErrorMessage('code') }}
            </small>
            <small *ngIf="employeeForm.get('code')?.hasError('pattern') && employeeForm.get('code')?.touched" 
                   class="p-error">
              <i class="pi pi-exclamation-circle mr-1"></i>
              {{ getErrorMessage('code') }}
            </small>
            <small *ngIf="codeExists" class="p-error">
              <i class="pi pi-exclamation-circle mr-1"></i>
              {{ getErrorMessage('code') }}
            </small>
            <small *ngIf="!checkingCode && !codeExists && employeeForm.get('code')?.valid && employeeForm.get('code')?.value" 
                   class="p-success">
              <i class="pi pi-check-circle mr-1"></i>
              Code is available
            </small>
          </div>
        </div>

        <!-- Name Field -->
        <div class="field mb-3">
          <label for="name" class="form-label">
            <i class="pi pi-user mr-2"></i>
            Employee Name *
          </label>
          <div class="p-inputgroup">
            <span class="p-inputgroup-addon">
              <i class="pi pi-user"></i>
            </span>
            <input 
              type="text" 
              id="name" 
              pInputText 
              formControlName="name" 
              placeholder="Enter employee name"
              [ngClass]="{ 'ng-invalid ng-dirty': employeeForm.get('name')?.invalid && employeeForm.get('name')?.touched }"
            />
          </div>
          
          <div class="validation-messages mt-1">
            <small *ngIf="employeeForm.get('name')?.hasError('required') && employeeForm.get('name')?.touched" 
                   class="p-error">
              <i class="pi pi-exclamation-circle mr-1"></i>
              {{ getErrorMessage('name') }}
            </small>
            <small *ngIf="employeeForm.get('name')?.hasError('pattern') && employeeForm.get('name')?.touched" 
                   class="p-error">
              <i class="pi pi-exclamation-circle mr-1"></i>
              {{ getErrorMessage('name') }}
            </small>
          </div>
        </div>

        <!-- Date of Birth Field -->
        <div class="field mb-3">
          <label for="dateOfBirth" class="form-label">
            <i class="pi pi-calendar mr-2"></i>
            Date of Birth
          </label>
          <p-calendar 
            id="dateOfBirth" 
            formControlName="dateOfBirth"
            [showIcon]="true"
            [maxDate]="maxDate"
            dateFormat="yy-mm-dd"
            placeholder="Select date of birth"
            [ngClass]="{ 'ng-invalid ng-dirty': employeeForm.get('dateOfBirth')?.invalid && employeeForm.get('dateOfBirth')?.touched }"
          ></p-calendar>
        </div>

        <!-- Mobile Field -->
        <div class="field mb-3">
          <label for="mobile" class="form-label">
            <i class="pi pi-phone mr-2"></i>
            Mobile Number
          </label>
          <div class="p-inputgroup">
            <span class="p-inputgroup-addon">
              <i class="pi pi-mobile"></i>
            </span>
            <input 
              type="text" 
              id="mobile" 
              pInputText 
              formControlName="mobile" 
              placeholder="01XXXXXXXXX"
              [ngClass]="{ 'ng-invalid ng-dirty': employeeForm.get('mobile')?.invalid && employeeForm.get('mobile')?.touched }"
            />
          </div>
          
          <div class="validation-messages mt-1">
            <small *ngIf="employeeForm.get('mobile')?.hasError('pattern') && employeeForm.get('mobile')?.touched" 
                   class="p-error">
              <i class="pi pi-exclamation-circle mr-1"></i>
              {{ getErrorMessage('mobile') }}
            </small>
            <small class="p-hint">
              <i class="pi pi-info-circle mr-1"></i>
              Format: 01XXXXXXXXX (11 digits)
            </small>
          </div>
        </div>

        <!-- Salary Field -->
        <div class="field mb-3">
          <label for="salary" class="form-label">
            <i class="pi pi-money-bill mr-2"></i>
            Salary *
          </label>
          <div class="p-inputgroup">
            <span class="p-inputgroup-addon">
              <i class="pi pi-dollar"></i>
            </span>
            <p-inputNumber 
              id="salary" 
              formControlName="salary"
              mode="currency" 
              currency="USD" 
              locale="en-US"
              placeholder="Enter salary"
              [min]="0.01"
              [minFractionDigits]="2"
              [maxFractionDigits]="2"
              [ngClass]="{ 'ng-invalid ng-dirty': employeeForm.get('salary')?.invalid && employeeForm.get('salary')?.touched }"
            ></p-inputNumber>
          </div>
          
          <div class="validation-messages mt-1">
            <small *ngIf="employeeForm.get('salary')?.hasError('required') && employeeForm.get('salary')?.touched" 
                   class="p-error">
              <i class="pi pi-exclamation-circle mr-1"></i>
              {{ getErrorMessage('salary') }}
            </small>
            <small *ngIf="employeeForm.get('salary')?.hasError('min') && employeeForm.get('salary')?.touched" 
                   class="p-error">
              <i class="pi pi-exclamation-circle mr-1"></i>
              {{ getErrorMessage('salary') }}
            </small>
          </div>
        </div>

        <!-- Department Field -->
        <div class="field mb-3">
          <label for="departmentId" class="form-label">
            <i class="pi pi-building mr-2"></i>
            Department *
          </label>
          <p-dropdown 
            id="departmentId" 
            formControlName="departmentId"
            [options]="departments"
            optionLabel="name" 
            optionValue="id"
            placeholder="Select department"
            [loading]="loadingDepartments"
            [ngClass]="{ 'ng-invalid ng-dirty': employeeForm.get('departmentId')?.invalid && employeeForm.get('departmentId')?.touched }"
          >
            <ng-template pTemplate="selectedItem">
              <span *ngIf="employeeForm.get('departmentId')?.value">
                {{ getDepartmentName(employeeForm.get('departmentId')?.value) }}
              </span>
              <span *ngIf="!employeeForm.get('departmentId')?.value">Select Department</span>
            </ng-template>
            <ng-template pTemplate="item" let-department>
              <div class="department-item">
                <span class="department-code">{{ department.code }}</span>
                <span class="department-name">{{ department.name }}</span>
              </div>
            </ng-template>
          </p-dropdown>
          
          <div class="validation-messages mt-1">
            <small *ngIf="employeeForm.get('departmentId')?.hasError('required') && employeeForm.get('departmentId')?.touched" 
                   class="p-error">
              <i class="pi pi-exclamation-circle mr-1"></i>
              {{ getErrorMessage('departmentId') }}
            </small>
          </div>
        </div>

        <!-- Status Field -->
        <div class="field mb-3" *ngIf="isEditMode">
          <div class="flex align-items-center">
            <p-checkbox 
              formControlName="isActive" 
              [binary]="true" 
              inputId="isActive"
            ></p-checkbox>
            <label for="isActive" class="ml-2 mb-0 cursor-pointer">
              <i class="pi pi-check-circle mr-2"></i>
              Active Employee
            </label>
          </div>
        </div>
      </div>

      <!-- Right Column - Image & Address -->
      <div class="form-column">
        <!-- Image Upload -->
        <div class="field mb-3">
          <label class="form-label">
            <i class="pi pi-image mr-2"></i>
            Employee Photo
          </label>
          <div class="image-upload-container" >
            <!-- Image Preview -->
            <div class="image-preview" *ngIf="imagePreview">
              <img [src]="imagePreview" alt="Employee photo" style="width: 100px;" class="preview-image" >
              <button 
                type="button" 
                class="remove-image-btn" 
                (click)="removeImage()"
                pTooltip="Remove photo"
              >
                <i class="pi pi-times"></i>
              </button>
            </div>
            
            <!-- Upload Area -->
            <div class="upload-area" *ngIf="!imagePreview">
              <p-fileUpload 
                mode="basic" 
                chooseLabel="Choose Photo"
                [accept]="acceptedFileTypes"
                [maxFileSize]="maxFileSize"
                [chooseIcon]="'pi pi-upload'"
                (onSelect)="onFileSelect($event)"
                [disabled]="uploadingImage"
              ></p-fileUpload>
              <small class="p-hint mt-2 d-block">
                <i class="pi pi-info-circle mr-1"></i>
                Max file size: 2MB, Allowed: JPG, PNG, GIF
              </small>
            </div>
          </div>
        </div>

        <!-- Address Field -->
        <div class="field mb-3">
          <label for="address" class="form-label">
            <i class="pi pi-map-marker mr-2"></i>
            Address
          </label>
          <textarea 
            id="address" 
            pTextarea 
            formControlName="address" 
            rows="4" 
            placeholder="Enter employee address"
            [autoResize]="true"
            [ngClass]="{ 'ng-invalid ng-dirty': employeeForm.get('address')?.invalid && employeeForm.get('address')?.touched }"
          ></textarea>
          
          <div class="validation-messages mt-1">
            <small *ngIf="employeeForm.get('address')?.hasError('maxlength') && employeeForm.get('address')?.touched" 
                   class="p-error">
              <i class="pi pi-exclamation-circle mr-1"></i>
              {{ getErrorMessage('address') }}
            </small>
            <small class="p-hint">
              <i class="pi pi-info-circle mr-1"></i>
              Maximum 500 characters ({{ employeeForm.get('address')?.value?.length || 0 }}/500)
            </small>
          </div>
        </div>
      </div>
    </div>

    <!-- Form Level Errors -->
    <div *ngIf="employeeForm.errors && employeeForm.touched" class="mb-3">
      <p-message severity="error" text="Please fix all errors before submitting"></p-message>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <div class="flex justify-content-between w-100">
      <button 
        pButton 
        type="button" 
        label="Cancel" 
        icon="pi pi-times" 
        class="p-button-secondary" 
        (click)="onClose()"
        [disabled]="submitting"
      ></button>
      <button 
        pButton 
        type="button" 
        [label]="submitButtonText" 
        [icon]="submitting ? 'pi pi-spinner pi-spin' : (isEditMode ? 'pi pi-check' : 'pi pi-plus')" 
        class="p-button-primary" 
        (click)="onSubmit()"
        [disabled]="employeeForm.invalid || submitting || codeExists"
      ></button>
    </div>
  </ng-template>

  <!-- Loading Overlay -->
  <div *ngIf="submitting || uploadingImage" class="loading-overlay">
    <div class="loading-content">
      <p-progressSpinner styleClass="w-2rem h-2rem" strokeWidth="4" fill="var(--surface-ground)" animationDuration=".5s"></p-progressSpinner>
      <p class="mt-3">
        {{ uploadingImage ? 'Uploading image...' : (isEditMode ? 'Updating employee...' : 'Creating employee...') }}
      </p>
    </div>
  </div>
</p-dialog>